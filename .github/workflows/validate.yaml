name: Validate Manifests

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  validate:
    name: Validate Kubernetes Manifests
    runs-on: blogstack-k8s-arc-runner-set
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Kustomize
        uses: imranismail/setup-kustomize@v2
        with:
          kustomize-version: "5.4.3"
      
      - name: Setup Kubeconform
        run: |
          curl -sSLo kubeconform.tar.gz https://github.com/yannh/kubeconform/releases/download/v0.6.7/kubeconform-linux-amd64.tar.gz
          tar xf kubeconform.tar.gz
          sudo mv kubeconform /usr/local/bin/
          rm kubeconform.tar.gz
      
      - name: Validate Ghost (prod)
        run: |
          kustomize build apps/ghost/overlays/prod | \
            kubeconform -summary -strict \
            -schema-location default \
            -schema-location 'https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/{{.Group}}/{{.ResourceKind}}_{{.ResourceAPIVersion}}.json' \
            -skip CustomResourceDefinition
      
      - name: Validate Ingress-NGINX (prod)
        run: |
          kustomize build apps/ingress-nginx/overlays/prod | \
            kubeconform -summary -strict \
            -schema-location default \
            -skip CustomResourceDefinition
      
      - name: Validate Cloudflared (prod)
        run: |
          kustomize build apps/cloudflared/overlays/prod | \
            kubeconform -summary -strict \
            -schema-location default
      
      - name: Validate Observers (prod)
        run: |
          kustomize build apps/observers/overlays/prod | \
            kubeconform -summary -strict \
            -schema-location default \
            -schema-location 'https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/{{.Group}}/{{.ResourceKind}}_{{.ResourceAPIVersion}}.json' \
            -skip CustomResourceDefinition
      
      - name: Validate Vault
        run: |
          kustomize build security/vault | \
            kubeconform -summary -strict \
            -schema-location default \
            -skip CustomResourceDefinition
      
      - name: Validate VSO
        run: |
          kustomize build security/vso | \
            kubeconform -summary -strict \
            -schema-location default \
            -schema-location 'https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/{{.Group}}/{{.ResourceKind}}_{{.ResourceAPIVersion}}.json' \
            -skip CustomResourceDefinition
      
      - name: Summary
        if: success()
        run: |
          echo "âœ… All manifests are valid!"
          echo "Ready for deployment."
