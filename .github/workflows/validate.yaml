name: Validate Manifests

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  validate:
    name: Validate Kubernetes Manifests
    runs-on: blogstack-k8s-arc-runner-set
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Kustomize
        uses: imranismail/setup-kustomize@v2
        with:
          kustomize-version: "5.4.3"
      
      - name: Setup Kubeconform
        run: |
          ARCH=$(uname -m)
          if [ "$ARCH" = "x86_64" ]; then
            KUBECONFORM_ARCH="amd64"
          elif [ "$ARCH" = "aarch64" ] || [ "$ARCH" = "arm64" ]; then
            KUBECONFORM_ARCH="arm64"
          else
            echo "Unsupported architecture: $ARCH"
            exit 1
          fi
          curl -sSLo kubeconform.tar.gz https://github.com/yannh/kubeconform/releases/download/v0.6.7/kubeconform-linux-${KUBECONFORM_ARCH}.tar.gz
          tar xf kubeconform.tar.gz
          sudo mv kubeconform /usr/local/bin/
          rm kubeconform.tar.gz
      
      - name: Validate Ghost (prod)
        run: |
          kustomize build --load-restrictor=LoadRestrictionsNone apps/ghost/overlays/prod | \
            kubeconform -summary -strict \
            -schema-location default \
            -schema-location 'https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/{{.Group}}/{{.ResourceKind}}_{{.ResourceAPIVersion}}.json' \
            -skip CustomResourceDefinition
      
      - name: Validate Ingress-NGINX (prod)
        run: |
          kustomize build --enable-helm --load-restrictor=LoadRestrictionsNone apps/ingress-nginx/overlays/prod | \
            kubeconform -summary -strict \
            -schema-location default \
            -skip CustomResourceDefinition
      
      - name: Validate Cloudflared (prod)
        run: |
          kustomize build --load-restrictor=LoadRestrictionsNone apps/cloudflared/overlays/prod | \
            kubeconform -summary -strict \
            -schema-location default \
            -skip ServiceMonitor
      
      - name: Validate Observers (prod)
        run: |
          kustomize build --load-restrictor=LoadRestrictionsNone apps/observers/overlays/prod | \
            kubeconform -summary -strict \
            -schema-location default \
            -schema-location 'https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/{{.Group}}/{{.ResourceKind}}_{{.ResourceAPIVersion}}.json' \
            -skip CustomResourceDefinition
      
      - name: Validate Vault
        run: |
          kustomize build --load-restrictor=LoadRestrictionsNone security/vault | \
            kubeconform -summary -strict \
            -schema-location default \
            -skip CustomResourceDefinition
      
      - name: Validate VSO
        run: |
          kustomize build --load-restrictor=LoadRestrictionsNone security/vso | \
            kubeconform -summary -strict \
            -schema-location default \
            -schema-location 'https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/{{.Group}}/{{.ResourceKind}}_{{.ResourceAPIVersion}}.json' \
            -skip CustomResourceDefinition
      
      - name: Summary
        if: success()
        run: |
          echo "âœ… All manifests are valid!"
          echo "Ready for deployment."
