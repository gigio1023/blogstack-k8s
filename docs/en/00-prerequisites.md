# 00. Prerequisites

Requirements before deploying blogstack-k8s

## 1. Infrastructure

### OCI VM Specs
- VM Shape: VM.Standard.A1.Flex (ARM64)
- OCPU: 4
- Memory: 24GB
- Storage: 100GB Boot Volume
- OS: Ubuntu 22.04 LTS (ARM64)

### Network Config

VCN Security List:

| Direction | CIDR | Protocol/Port | Purpose |
|-----------|------|---------------|---------|
| Egress | 0.0.0.0/0 | TCP/443 | Required: GitHub, Docker Hub, Helm |
| Egress | 0.0.0.0/0 | TCP/80 | Optional: Package updates |
| Ingress | - | - | Not needed (Cloudflare Tunnel) |

Keep Ingress closed except SSH (22)

### VM Access Check

```bash
ssh -i ~/.ssh/oci_key ubuntu@<VM_PUBLIC_IP>

uname -m  # aarch64
df -h     # At least 50GB free
```

## 2. Cloudflare Setup

### 2.1. Account & Domain

1. Sign up at https://dash.cloudflare.com/sign-up
2. Prepare domain

Option A: Buy via Cloudflare Registrar (recommended)
- Domain Registration → Register Domains
- Auto DNS setup, cheaper renewals

Option B: Add existing domain
- Add a Site → Enter domain
- Plan: Free
- Change nameservers at your registrar

```bash
# Verify nameserver change (up to 24h)
dig NS yourdomain.com +short
# Output: chad.ns.cloudflare.com, dina.ns.cloudflare.com
```

### 2.2. Cloudflare Zero Trust

1. Go to https://one.dash.cloudflare.com/
2. Enter team name
3. Plan: Free (50 users)

### 2.3. Cloudflare Tunnel

1. Zero Trust: Networks → Tunnels → Create a tunnel
2. Type: Cloudflared
3. Name: `blogstack-tunnel`
4. Copy token (Base64 string, ~200 chars)
5. Skip connector installation (runs in Kubernetes)

Public hostname setup done in 05-cloudflare-setup.md

### 2.4. Zero Trust Access (Optional)

Protect Ghost Admin (`/ghost/*`):

1. Settings → Authentication → Connect Google/GitHub
2. Access → Applications → Add
   - Type: Self-hosted
   - Name: `Ghost Admin`
   - Domain: `yourdomain.com`
   - Path: `/ghost/*`
3. Policy:
   - Name: `Admin Only`
   - Action: Allow
   - Include: Emails

## 3. Dev Tools

### On VM

```bash
ssh -i ~/.ssh/oci_key ubuntu@<VM_PUBLIC_IP>

sudo apt update
sudo apt install -y curl git jq

git --version  # 2.30+
# kubectl installed with k3s
```

### Local (Optional)

```bash
# macOS
brew install kubectl kustomize

# Linux
curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
```

## 4. Required Credentials

| Item | Value | Notes |
|------|-------|-------|
| Cloudflare | Tunnel Token | Base64 string (~200 chars) |
| MySQL | Root Password | Generate (8+ chars) |
| | Ghost Password | Generate (8+ chars) |
| Ghost | URL | `https://yourdomain.com` |
| Mailgun | SMTP Host | `smtp.mailgun.org` |
| | SMTP Username | `postmaster@mg.yourdomain.com` |
| | SMTP Password | From Mailgun |
| | From Email | `noreply@yourdomain.com` |

## 5. Network Check

```bash
# Verify GitHub, Docker Hub, Cloudflare API access
curl -I https://github.com
curl -I https://registry.hub.docker.com
curl -I https://api.cloudflare.com
# Expect: HTTP/2 200 or 3xx
```

OCI Security List: Egress `0.0.0.0/0:443` required

## 6. SMTP Email Setup (Required)

Ghost requires SMTP for password resets and login

### Mailgun Signup

#### Step 1: Sign up

1. Go to https://signup.mailgun.com/
2. Sign up for free
3. Verify email

Free plan: 5,000 emails/month

#### Step 2: Add Sending Domain

1. Mailgun: Sending → Domains → Add New Domain
2. Domain: `mg.yourdomain.com` (subdomain recommended)

#### Step 3: Add DNS Records (Cloudflare)

Cloudflare: DNS → Records → Add records from Mailgun

| Type | Name | Value | Proxy Status |
|------|------|-------|--------------|
| TXT | `mg` | `v=spf1 include:mailgun.org ~all` | DNS only |
| TXT | `k1._domainkey.mg` | Mailgun DKIM key | DNS only |
| CNAME | `email.mg` | `mailgun.org` | DNS only |
| MX | `mg` | `mxa.mailgun.org` (Priority: 10) | DNS only |
| MX | `mg` | `mxb.mailgun.org` (Priority: 10) | DNS only |

Important: Proxy Status must be DNS only (gray cloud)

#### Step 4: Verify Domain

Check Mailgun dashboard for Status: Verified (up to 48h, usually 10m)

#### Step 5: Get SMTP Credentials

Mailgun: Sending → Domain settings → SMTP Credentials

- Host: `smtp.mailgun.org`
- Port: `587`
- Username: `postmaster@mg.yourdomain.com`
- Password: Auto-generated by Mailgun

Save these for 07-smtp-setup.md

## 7. Final Checklist

### Infrastructure
- [ ] OCI VM created (ARM64, Ubuntu 22.04, 4 OCPU, 24GB RAM, 100GB disk)
- [ ] SSH access works
- [ ] VM egress 443/tcp allowed

### External Services
- [ ] Domain ready
- [ ] Cloudflare account created
- [ ] Domain on Cloudflare DNS (`dig NS` check)
- [ ] Cloudflare Zero Trust activated
- [ ] Cloudflare Tunnel created & token copied
- [ ] Mailgun account created & domain verified
- [ ] Mailgun DNS records added to Cloudflare

### Credentials
- [ ] MySQL passwords generated (Root, Ghost)
- [ ] Mailgun SMTP credentials verified
- [ ] All credentials stored securely

### Tools
- [ ] Git installed on VM
- [ ] (Optional) kubectl, kustomize on local

## Next Steps

→ [CUSTOMIZATION.md](./CUSTOMIZATION.md) - Git URL & domain config

→ [01-infrastructure.md](./01-infrastructure.md) - k3s installation

## Optional Features

### Backup (OCI Object Storage)

Auto-backup MySQL/Ghost content

1. OCI: Storage → Buckets → Create Bucket
   - Name: `blog-backups`
   - Tier: Standard
2. Generate Customer Secret Keys (S3 API)
3. Get endpoint URL: `https://<namespace>.compat.objectstorage.<region>.oraclecloud.com`
4. See `apps/ghost/optional/README.md`
